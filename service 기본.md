<a href="https://github.com/och5351/cluster#readme">메인으로</a>

<a id="home1"></a>

# 서비스란?

<br>
쿠버네티스의 서비스는 클라이언트의 요청을 파드에 전달하는 역할을 담당한다. 이러한 서비스가 필요한 이유는 파드의 IP 주소가 기동할 때마다 바뀌기 때문. 그래서 파드에 접속해야하는 클라이언트는 서비스가 가지는 대표 IP를 사용해서 접속해야 한다.

<br>


<br><br>

## 목차

- [서비스 역할](#1)
- [대표 IP 주소](#2)
- [부하 분산](#3)
- [Pod의 종료 처리 흐름](#4)
- [클러스터 네트워크](#5)

<br><br>

<br>
<div align="right"> 

[목차로](#home1) 
</div><br><br>

<a id="1"></a>

# 서비스 역할

<br>

<div align="center">
<img src="https://user-images.githubusercontent.com/45858414/128621376-1b33eb03-283a-49ff-9b1a-11dd0c5eb3bb.png" width="70%"  height="70%" />
</div>

<br>

1. 서비스는 로드밸런서의 역할을 가지며, 클라이언트의 요청을 받기 위한 대표 IP 주소를 획득한다.
2. 서비스의 이름은 내부 DNS에 등록되기 때문에 클라이언트는 서비스의 이름만으로 서비스의 IP 주소를 획득할 수 있다.
3. 서비스는 Selector에 지정된 라벨과 일치하는 파드 중 하나에게 요청을 전달한다. (파드는 기동될 때 라벨이나 IP 주소를 포함한 자신의 오브젝트 정보를 마스터 노드의 etcd에 등록, 서비스는 Selector 의 라벨에 일치하는 파드를 etcd에서 조회&취득)
4. 서비스가 만들어지고 나서 기동된 파등의 컨테이너에는 서비스에 대한 정보가 담긴 환경 변수가 자동으로 설정된다.
5. 서비스에는 4 종류의 서비스 타입이 있어, 클라이언트의 범위를 k8s 클러스터 내부로 한정할지, 외부까지 확장할지, 또한 k8s 클러스터 외부의 IP 주소에 전송할지를 설정한다.

<br>
<div align="right"> 

[목차로](#home1) 
</div><br><br>

<a id="2"></a>

# 대표 IP 주소

<br>

서비스는 파드의 그룹을 대표하여 클라이언트의 요청을 받기 위해 대표 IP 주소(ClusterIP)를 가진다. 헤드리스로 지정한 경우에는 대표 IP 주소를 획득하지 않고, 파드의 IP 주소를 직접 내부 DNS에 설정한다.

<br>
<div align="right"> 

[목차로](#home1) 
</div><br><br>

<a id="3"></a>

# 부하 분산

<br>

서비스의 대표 IP 주소에 도착한 요청은 Selector의 라벨과 일치하는 파드에 전송된다. 이를 위한 모듈인 kube-proxy는 초창기에는 커널의 유저 공간에서 동작하는 프록시 서버였지만, 지금은 [iptables](#https://itwiki.kr/w/리눅스_iptables) 나 ipvs를 관리하는 프로그램으로 바뀌었다.

